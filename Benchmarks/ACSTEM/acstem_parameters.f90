MODULE acstem_parameters

! Parameters of the acstem
    IMPLICIT NONE
    INTEGER, PARAMETER, PRIVATE :: DP     = KIND(1.0D0)
    INTEGER, PARAMETER :: NATOMS = 55                      ! NUMBER OF ATOMS
    INTEGER, PARAMETER :: NDIMS  = 3*NATOMS + 2            ! NUMBER OF DIMENSIONS
    INTEGER, PARAMETER :: NROWS  = 128                     ! NUMBER OF ROWS, IN PIXELS, IN THE IMAGE
    INTEGER, PARAMETER :: NCOLS  = 128                     ! NUMBER OF COLUMNS, IN PIXELS, IN THE IMAGE
    REAL(KIND=DP), PARAMETER  :: IMAGE_WIDTH = 20.0D0      ! IN NANOMETERS
    REAL(KIND=DP), PARAMETER  :: IMAGE_HEIGHT= 20.0D0      ! IN NANOMETERS

!    REAL(KIND=DP), PARAMETER, PRIVATE  :: LBX = -IMAGE_WIDTH/2.0D0
!    REAL(KIND=DP), PARAMETER, PRIVATE  :: UBX =  IMAGE_WIDTH/2.0D0
!    REAL(KIND=DP), PARAMETER, PRIVATE  :: LBY = -IMAGE_HEIGHT/2.0D0
!    REAL(KIND=DP), PARAMETER, PRIVATE  :: UBY =  IMAGE_HEIGHT/2.0D0
!    REAL(KIND=DP), DIMENSION(NDIMS, NDIMS), SAVE :: HESSIAN          ! HESSIAN MATRIX OF THE OBJECTIVE FUNCTION
!    REAL(KIND=DP), DIMENSION(NROWS, NCOLS), SAVE :: MODEL_IMAGE
    REAL(KIND=DP), DIMENSION(NROWS, NCOLS), PROTECTED, SAVE :: EXPT_IMAGE

    ! POTENTIAL PARAMETERS
    INTEGER, PARAMETER :: ATOMTYPE         = 23                ! GOLD
    INTEGER, PARAMETER :: ATOMIC_NUMBER    = 79                ! ATOMIC NUMBER
    REAL(KIND=DP), PARAMETER :: MORSE_RHO = 1.0D0
    REAL(KIND=DP), PARAMETER :: MORSE_A   = 1.0D0
    CHARACTER(LEN=5), PROTECTED:: POTTYPE = "GUPTA"
    

    ! GAUSSIAN SETTINGS
    REAL(KIND=DP), DIMENSION(NDIMS), PROTECTED, PUBLIC :: LOWERBOUND = 0.0D0 !MIN(LBX, LBY)       ! LOWER LIMIT ON THE VALUE OF COORDINATES
    REAL(KIND=DP), DIMENSION(NDIMS), PROTECTED, PUBLIC :: UPPERBOUND = 0.0D0 !MAX(UBX, UBY)       ! UPPER LIMIT ON THE VALUE OF THE COORDINATES
!    REAL(KIND=DP), PARAMETER, PRIVATE       :: GAUSS_WIDTH_DEFAULT = 1.0D0        ! IN NANOMETERS
!    REAL(KIND=DP), PARAMETER, PRIVATE       :: GAUSS_HEIGHT_DEFAULT = 1.0D0     ! IN NANOMETERS
    CHARACTER(LEN=100), PARAMETER, PRIVATE  :: EXPT_IMFILE = "/Users/KSB/Documents/workspace1/Filtering/20000000X_0020.txt"

   ! FILTERING PARAMETERS
    REAL(KIND=DP), PARAMETER :: INTENSITY_CUTOFF = 2.750D4
    INTEGER, PARAMETER :: FILTER_MASK_SIZE = 9
    INTEGER, PARAMETER :: NOISE_NROWS = 10
    INTEGER, PARAMETER :: NOISE_NCOLS = 10
    INTEGER, PARAMETER :: NOISE_SIZE = NOISE_NROWS*NOISE_NCOLS
    INTEGER, PARAMETER :: NFILTER_PASSES = 3
    LOGICAL, PRIVATE, SAVE :: INIT=.TRUE.
    CONTAINS
    SUBROUTINE ACSTEM_SETUP()
        USE FILTER, ONLY: SETUP_MASKS, ADAPTIVE_MEDIAN_FILTER !adaptive_median_filter
        IMPLICIT NONE
        INTEGER :: I, MYUNIT
        REAL(KIND=8) :: NOISE_AVG, NOISE_VAR, NOISE_CUTOFF
        REAL(KIND=8), DIMENSION(NROWS, NCOLS) :: TMP_IMAGE
        REAL(KIND=8), DIMENSION(NOISE_NROWS, NOISE_NCOLS) :: NOISE_WINDOW
        PRINT*, "SETING UP"
        !STOP
        DO I=1, NATOMS
            LOWERBOUND(3*I - 2) = -IMAGE_WIDTH/2.0D0
            LOWERBOUND(3*I - 1) = -IMAGE_HEIGHT/2.0D0
            LOWERBOUND(3*I)     = -MAX(IMAGE_WIDTH, IMAGE_HEIGHT)/2.0D0
            UPPERBOUND(3*I - 2) = IMAGE_WIDTH/2.0D0
            UPPERBOUND(3*I - 1) = IMAGE_HEIGHT/2.0D0
            UPPERBOUND(3*I)     = MAX(IMAGE_WIDTH, IMAGE_HEIGHT)/2.0D0
        ENDDO
        ! BOUNDS ON GAUSSAIN WIDTH
       ! BOUNDS ON GAUSSAIN WIDTH
        LOWERBOUND(NDIMS - 1)  = 0.50D0     ! THIS IS TAKEN FROM ZOOMED IN EXPERIMENTAL IMAGE
        UPPERBOUND(NDIMS - 1)  = 0.0D0      ! THIS IS TAKEN FROM THE EXPERIMENTAL IMAGE
        ! BOUNDS ON GAUSSIAN HEIGHT
        LOWERBOUND(NDIMS)      = 1.10D0     ! THIS IS MAXIMUM OF THE GUASSIAN WIDTH 
        UPPERBOUND(NDIMS)      = 0.0D0      ! THIS IS MAXIMUM OF THE GUASSIAN HEIGHT
        IF(INIT) THEN
            !   EXPT_IMAGE = 0.0D0
            PRINT*, "LOADING EXPERIMENTAL IMAGE"
            CALL LOADIMAGE(EXPT_IMFILE, NROWS, NCOLS, EXPT_IMAGE)
            ! ESITIMATE THE OVERALL NOISE VARIANCE OF THE IMAGE FROM THE NOISE SAMPLE
            NOISE_WINDOW = EXPT_IMAGE(1:NOISE_NROWS, 1:NOISE_NCOLS)
            NOISE_AVG = SUM(NOISE_WINDOW)/DBLE(NOISE_SIZE)
            NOISE_VAR = SUM((NOISE_WINDOW - NOISE_AVG)**2)/DBLE(NOISE_SIZE)
            CALL SETUP_MASKS() ! setup_masks()
            !   ROMOVE NOIZE
            PRINT*, "FILTERING EXPERIMENTAL IMAGE."
	    NOISE_CUTOFF = NOISE_AVG
            DO I=1, NFILTER_PASSES
                CALL ADAPTIVE_MEDIAN_FILTER(EXPT_IMAGE, TMP_IMAGE, &
                NROWS, NCOLS, FILTER_MASK_SIZE, NOISE_VAR, NOISE_CUTOFF)
                EXPT_IMAGE = TMP_IMAGE
            ENDDO
            PRINT*, "SAVING FILTERED EXPERIMENTAL IMAGE."
            OPEN(NEWUNIT=MYUNIT, FILE="filterd_expt_image.txt", ACTION="WRITE")
            DO I=1, NROWS
                WRITE(MYUNIT, *) EXPT_IMAGE(I,:)
            ENDDO
            CLOSE(MYUNIT)
            ! SET THE POTENTIAL TYPE
            CALL TO_UPPER(POTTYPE) !
            POTTYPE = ADJUSTL(TRIM(POTTYPE))
            !    mask_size, noise_variance, cutoff)
            INIT = .FALSE.
            PRINT*, "SETUP SUCCESSFULLY COMPLETED."
            !STOP
        ENDIF
    END SUBROUTINE ACSTEM_SETUP
END MODULE acstem_parameters
